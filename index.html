<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Aura Elite</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --primary: #5856D6; --accent: #AF52DE; --bg: #000000;
            --card: #1C1C1E; --text: #FFFFFF;
        }
        body { font-family: -apple-system, system-ui; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        #onboarding { position: fixed; inset: 0; background: var(--bg); z-index: 1000; padding: 40px 25px; display: none; }
        .container { padding: 60px 20px 100px; }
        .card { background: var(--card); border-radius: 24px; padding: 20px; margin-bottom: 20px; border: 1px solid #38383A; }
        
        /* Ring */
        .ring-container { position: relative; width: 200px; height: 200px; margin: 0 auto 20px; }
        svg { transform: rotate(-90deg); }
        circle { fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 0.5s ease; }
        .bg-ring { stroke: #38383A; }
        .main-ring { stroke: var(--primary); }
        .ring-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }

        /* Scanner */
        #reader { width: 100%; border-radius: 12px; overflow: hidden; display: none; border: 2px solid var(--primary); background: #000; }
        
        input { width: 100%; padding: 16px; background: #2C2C2E; border: none; border-radius: 14px; color: white; margin: 10px 0; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border: none; border-radius: 16px; font-weight: 700; font-size: 17px; margin-top: 10px; }
        
        .macro-info { display: flex; justify-content: space-around; font-size: 12px; color: #8E8E93; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="onboarding">
        <h1>Welcome.</h1>
        <input type="number" id="curr-w" placeholder="Weight (kg)">
        <button onclick="saveProfile()">Set 3,400 kcal Goal</button>
    </div>

    <div class="container">
        <div class="ring-container">
            <svg width="200" height="200">
                <circle class="bg-ring" cx="100" cy="100" r="85"></circle>
                <circle id="ring-fill" class="main-ring" cx="100" cy="100" r="85" stroke-dasharray="534" stroke-dashoffset="534"></circle>
            </svg>
            <div class="ring-text">
                <div style="font-size: 32px; font-weight: 800;" id="cals-left">0</div>
                <div style="font-size: 10px; color: #8E8E93;">KCAL REMAINING</div>
            </div>
        </div>

        <div class="card">
            <div id="reader"></div>
            <p id="scan-status" style="text-align:center; font-size:12px; color:var(--primary)"></p>
            
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" id="food-n" placeholder="Meal Name" style="flex: 1; margin: 0;">
                <button onclick="startScanner()" style="width: 60px; margin: 0; background: #2C2C2E; border: 1px solid var(--primary);">ðŸ“·</button>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                <input type="number" id="f-kcal" placeholder="Calories">
                <input type="number" id="f-p" placeholder="Protein (g)">
            </div>
            <button onclick="addEntry()">Add to Daily Intake</button>
        </div>
        
        <button onclick="localStorage.clear(); location.reload();" style="background:none; color:grey; font-size:10px">Reset Profile</button>
    </div>

    <script>
        let profile = JSON.parse(localStorage.getItem('aura_profile'));
        let logs = JSON.parse(localStorage.getItem('aura_logs')) || {};
        let today = new Date().toISOString().split('T')[0];
        let scanner;

        function saveProfile() {
            const w = parseFloat(document.getElementById('curr-w').value) || 57;
            profile = { targetCals: 3400, p: Math.round(w * 2.2) };
            localStorage.setItem('aura_profile', JSON.stringify(profile));
            location.reload();
        }

        async function startScanner() {
            const r = document.getElementById('reader');
            r.style.display = 'block';
            document.getElementById('scan-status').innerText = "Hold 6 inches away & keep steady...";

            if (!scanner) {
                scanner = new Html5Qrcode("reader");
            }

            const config = { 
                fps: 20, 
                qrbox: { width: 280, height: 120 }, // Rectangle shape for barcodes
                aspectRatio: 1.0 
            };

            // Use 'environment' for back camera
            scanner.start({ facingMode: "environment" }, config, (text) => {
                document.getElementById('scan-status').innerText = "Code Detected!";
                fetchProduct(text);
                scanner.stop();
                r.style.display = 'none';
            }).catch(err => {
                document.getElementById('scan-status').innerText = "Camera Error: Check HTTPS/Permissions";
            });
        }

        async function fetchProduct(code) {
            try {
                const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
                const data = await res.json();
                if(data.status === 1) {
                    document.getElementById('food-n').value = data.product.product_name || "Unknown";
                    document.getElementById('f-kcal').value = Math.round(data.product.nutriments['energy-kcal_100g'] || 0);
                    document.getElementById('f-p').value = Math.round(data.product.nutriments.proteins_100g || 0);
                }
            } catch (e) { alert("API Error"); }
        }

        function addEntry() {
            const k = parseInt(document.getElementById('f-kcal').value || 0);
            if(!logs[today]) logs[today] = [];
            logs[today].push({ k });
            localStorage.setItem('aura_logs', JSON.stringify(logs));
            updateUI();
        }

        function updateUI() {
            if(!profile) { document.getElementById('onboarding').style.display='block'; return; }
            let total = (logs[today] || []).reduce((sum, item) => sum + item.k, 0);
            const ring = document.getElementById('ring-fill');
            const percent = Math.min(total / profile.targetCals, 1);
            ring.style.strokeDashoffset = 534 - (534 * percent);
            document.getElementById('cals-left').innerText = Math.max(0, profile.targetCals - total);
        }
        updateUI();
    </script>
</body>
</html>
