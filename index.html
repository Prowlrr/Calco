<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Aura Nutrition</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --primary: #5856D6; --accent: #AF52DE; --success: #34C759;
            --warning: #FF9500; --danger: #FF3B30; --bg: #000000;
            --card: #1C1C1E; --text: #FFFFFF;
        }
        body { 
            font-family: -apple-system, system-ui; background: var(--bg); 
            color: var(--text); margin: 0; padding: 0; overflow-x: hidden;
        }
        #onboarding { 
            position: fixed; inset: 0; background: var(--bg); z-index: 1000; 
            padding: 40px 25px; overflow-y: auto; display: none; 
        }
        .container { padding: 60px 20px 100px; }
        .card { 
            background: var(--card); border-radius: 24px; padding: 20px; 
            margin-bottom: 20px; border: 1px solid #38383A;
        }
        
        /* The Ring */
        .ring-container { position: relative; width: 200px; height: 200px; margin: 0 auto 20px; }
        svg { transform: rotate(-90deg); }
        circle { fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 0.5s ease; }
        .bg-ring { stroke: #38383A; }
        .main-ring { stroke: var(--primary); }
        .ring-text { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            text-align: center; 
        }

        /* Macro Bars */
        .macro-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        .macro-label { font-size: 10px; color: #8E8E93; text-transform: uppercase; margin-bottom: 4px; }
        .progress-bar { height: 6px; background: #38383A; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.3s; }

        /* Inputs */
        input, select { 
            width: 100%; padding: 16px; background: #2C2C2E; border: none; 
            border-radius: 14px; color: white; margin: 10px 0; font-size: 16px; box-sizing: border-box;
        }
        .slider-label { display: flex; justify-content: space-between; margin-top: 15px; font-size: 14px; }
        input[type="range"] { height: 30px; accent-color: var(--primary); }
        button { 
            width: 100%; padding: 18px; background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white; border: none; border-radius: 16px; font-weight: 700; font-size: 17px; margin-top: 20px;
        }
    </style>
</head>
<body>

    <div id="onboarding">
        <h1>Set Your Goal</h1>
        <label>Current Weight (kg)</label>
        <input type="number" id="curr-w" placeholder="80">
        <label>Target Weight (kg)</label>
        <input type="number" id="target-w" placeholder="75">
        
        <div class="slider-label">
            <span>Aggressiveness (Speed)</span>
            <span id="speed-val">Steady</span>
        </div>
        <input type="range" id="speed" min="250" max="1000" step="250" value="500" 
               oninput="document.getElementById('speed-val').innerText = this.value == 1000 ? 'Aggressive' : (this.value == 250 ? 'Steady' : 'Moderate')">
        
        <button onclick="saveProfile()">Create Personal Plan</button>
    </div>

    <div class="container">
        <div class="ring-container">
            <svg width="200" height="200">
                <circle class="bg-ring" cx="100" cy="100" r="85"></circle>
                <circle class="main-ring" id="ring-fill" cx="100" cy="100" r="85" stroke-dasharray="534" stroke-dashoffset="534"></circle>
            </svg>
            <div class="ring-text">
                <div style="font-size: 32px; font-weight: 800;" id="cals-left">0</div>
                <div style="font-size: 12px; color: #8E8E93;">KCAL LEFT</div>
            </div>
        </div>

        <div class="card">
            <div class="macro-grid">
                <div>
                    <div class="macro-label">Protein</div>
                    <div class="progress-bar"><div id="p-bar" class="progress-fill" style="background:var(--danger)"></div></div>
                    <div style="font-size: 12px; margin-top:4px"><span id="p-cur">0</span>/<span id="p-max">0</span>g</div>
                </div>
                <div>
                    <div class="macro-label">Carbs</div>
                    <div class="progress-bar"><div id="c-bar" class="progress-fill" style="background:var(--success)"></div></div>
                    <div style="font-size: 12px; margin-top:4px"><span id="c-cur">0</span>/<span id="c-max">0</span>g</div>
                </div>
                <div>
                    <div class="macro-label">Fat</div>
                    <div class="progress-bar"><div id="f-bar" class="progress-fill" style="background:var(--warning)"></div></div>
                    <div style="font-size: 12px; margin-top:4px"><span id="f-cur">0</span>/<span id="f-max">0</span>g</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin:0 0 15px 0">Log Nutrition</h3>
            
            <div id="reader" style="width: 100%; border-radius: 12px; overflow: hidden; display: none; margin-bottom: 10px;"></div>
            <div id="scan-status" style="font-size: 12px; color: var(--success); text-align: center; margin-bottom: 5px;"></div>
            
            <div style="display: flex; gap: 10px; margin: 10px 0;">
                <input type="text" id="food-n" placeholder="Meal Name" style="flex: 1; margin: 0;">
                <button onclick="startScanner()" style="width: 60px; margin: 0; padding: 0; background: #2C2C2E; border: 1px solid var(--primary); border-radius: 14px; display: flex; justify-content: center; align-items: center;">
                    <span style="font-size: 24px;">ðŸ“·</span>
                </button>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                <input type="number" id="f-kcal" placeholder="Cals" inputmode="numeric">
                <input type="number" id="f-p" placeholder="Prot (g)" inputmode="numeric">
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                <input type="number" id="f-c" placeholder="Carb (g)" inputmode="numeric">
                <input type="number" id="f-f" placeholder="Fat (g)" inputmode="numeric">
            </div>
            <button onclick="addEntry()">Add Meal</button>
        </div>
        
        <button onclick="localStorage.clear(); location.reload();" style="background:none; color:grey; font-size:12px; margin-top: 10px; box-shadow: none;">Reset All Data</button>
    </div>

    <script>
        let profile = JSON.parse(localStorage.getItem('aura_profile'));
        let logs = JSON.parse(localStorage.getItem('aura_logs')) || {};
        let today = new Date().toISOString().split('T')[0];
        let html5QrCode;

        function saveProfile() {
            const w = parseFloat(document.getElementById('curr-w').value);
            const tw = parseFloat(document.getElementById('target-w').value);
            const speed = parseInt(document.getElementById('speed').value);
            
            if(!w || !tw) return alert("Please fill in weights");

            const bmr = (10 * w) + 600; // Simplified BMR
            let targetCals = tw < w ? bmr - speed : bmr + speed;
            
            profile = {
                targetCals,
                p: Math.round(w * 2), // 2g protein per kg
                f: Math.round((targetCals * 0.25) / 9), // 25% fats
                c: Math.round((targetCals - (w*2*4) - (targetCals*0.25)) / 4)
            };
            localStorage.setItem('aura_profile', JSON.stringify(profile));
            location.reload();
        }

        // --- UPDATED SCANNER LOGIC ---
        function startScanner() {
            document.getElementById('reader').style.display = 'block';
            document.getElementById('scan-status').innerText = "Starting camera...";
            
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }

            // Fix: Wide rectangle forces the scanner to read entire 1D barcodes
            const config = { fps: 15, qrbox: { width: 300, height: 100 } };

            html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
                html5QrCode.stop().then(() => {
                    document.getElementById('reader').style.display = 'none';
                    document.getElementById('scan-status').innerText = "Found: " + decodedText;
                    fetchProductData(decodedText);
                });
            }).catch(err => {
                document.getElementById('scan-status').innerText = "Camera permission denied.";
            });
        }

        async function fetchProductData(barcode) {
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();
                
                if (data.status === 1) {
                    const p = data.product;
                    document.getElementById('food-n').value = p.product_name || "Unknown Product";
                    document.getElementById('f-kcal').value = Math.round(p.nutriments['energy-kcal_100g'] || 0);
                    document.getElementById('f-p').value = Math.round(p.nutriments.proteins_100g || 0);
                    document.getElementById('f-c').value = Math.round(p.nutriments.carbohydrates_100g || 0);
                    document.getElementById('f-f').value = Math.round(p.nutriments.fat_100g || 0);
                    document.getElementById('scan-status').innerText = "Match found! (per 100g)";
                } else {
                    document.getElementById('scan-status').innerText = "Product not in database.";
                }
            } catch (e) {
                document.getElementById('scan-status').innerText = "Error connecting to database.";
            }
        }
        // -----------------------------

        function addEntry() {
            const entry = {
                k: parseInt(document.getElementById('f-kcal').value || 0),
                p: parseInt(document.getElementById('f-p').value || 0),
                c: parseInt(document.getElementById('f-c').value || 0),
                f: parseInt(document.getElementById('f-f').value || 0)
            };
            if(!logs[today]) logs[today] = [];
            logs[today].push(entry);
            localStorage.setItem('aura_logs', JSON.stringify(logs));
            updateUI();
        }

        function updateUI() {
            if(!profile) { document.getElementById('onboarding').style.display='block'; return; }
            
            let totals = {k:0, p:0, c:0, f:0};
            (logs[today] || []).forEach(l => { totals.k += l.k; totals.p += l.p; totals.c += l.c; totals.f += l.f; });

            // Update Ring
            const ring = document.getElementById('ring-fill');
            const percent = Math.min(totals.k / profile.targetCals, 1);
            ring.style.strokeDashoffset = 534 - (534 * percent);
            document.getElementById('cals-left').innerText = Math.max(0, profile.targetCals - totals.k);

            // Update Macros
            const updateMacro = (id, cur, max) => {
                document.getElementById(id+'-cur').innerText = cur;
                document.getElementById(id+'-max').innerText = max;
                document.getElementById(id+'-bar').style.width = Math.min((cur/max)*100, 100) + '%';
            };
            updateMacro('p', totals.p, profile.p);
            updateMacro('c', totals.c, profile.c);
            updateMacro('f', totals.f, profile.f);
        }

        updateUI();
    </script>
</body>
</html>
