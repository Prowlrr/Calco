<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Aura Nutrition</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --primary: #5856D6; --accent: #AF52DE; --success: #34C759;
            --warning: #FF9500; --danger: #FF3B30; --bg: #000000;
            --card: #1C1C1E; --text: #FFFFFF;
        }
        body { font-family: -apple-system, system-ui; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        #onboarding { position: fixed; inset: 0; background: var(--bg); z-index: 1000; padding: 40px 25px; display: none; }
        .container { padding: 60px 20px 100px; }
        .card { background: var(--card); border-radius: 24px; padding: 20px; margin-bottom: 20px; border: 1px solid #38383A; }
        
        /* Ring */
        .ring-container { position: relative; width: 200px; height: 200px; margin: 0 auto 20px; }
        svg { transform: rotate(-90deg); }
        circle { fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 0.5s ease; }
        .bg-ring { stroke: #38383A; }
        .main-ring { stroke: var(--primary); }
        .ring-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }

        /* Macro UI */
        .macro-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        .macro-label { font-size: 10px; color: #8E8E93; text-transform: uppercase; margin-bottom: 4px; }
        .progress-bar { height: 6px; background: #38383A; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.3s; }

        /* Scanner Styling */
        #reader { width: 100%; border-radius: 12px; overflow: hidden; display: none; position: relative; border: 1px solid var(--primary); }
        .scan-line { position: absolute; top: 50%; left: 10%; width: 80%; height: 2px; background: red; box-shadow: 0 0 8px red; z-index: 10; pointer-events: none; }

        input { width: 100%; padding: 16px; background: #2C2C2E; border: none; border-radius: 14px; color: white; margin: 10px 0; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border: none; border-radius: 16px; font-weight: 700; font-size: 17px; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="onboarding">
        <h1>Set Your Goal</h1>
        <input type="number" id="curr-w" placeholder="Current Weight (kg)">
        <input type="number" id="target-w" placeholder="Target Weight (kg)">
        <input type="range" id="speed" min="250" max="1000" step="250" value="500">
        <button onclick="saveProfile()">Create Plan</button>
    </div>

    <div class="container">
        <div class="ring-container">
            <svg width="200" height="200">
                <circle class="bg-ring" cx="100" cy="100" r="85"></circle>
                <circle class="main-ring" id="ring-fill" cx="100" cy="100" r="85" stroke-dasharray="534" stroke-dashoffset="534"></circle>
            </svg>
            <div class="ring-text">
                <div style="font-size: 32px; font-weight: 800;" id="cals-left">0</div>
                <div style="font-size: 12px; color: #8E8E93;">KCAL LEFT</div>
            </div>
        </div>

        <div class="card">
            <div class="macro-grid">
                <div>
                    <div class="macro-label">P</div>
                    <div class="progress-bar"><div id="p-bar" class="progress-fill" style="background:var(--danger)"></div></div>
                    <div style="font-size: 11px; margin-top:4px"><span id="p-cur">0</span>g</div>
                </div>
                <div>
                    <div class="macro-label">C</div>
                    <div class="progress-bar"><div id="c-bar" class="progress-fill" style="background:var(--success)"></div></div>
                    <div style="font-size: 11px; margin-top:4px"><span id="c-cur">0</span>g</div>
                </div>
                <div>
                    <div class="macro-label">F</div>
                    <div class="progress-bar"><div id="f-bar" class="progress-fill" style="background:var(--warning)"></div></div>
                    <div style="font-size: 11px; margin-top:4px"><span id="f-cur">0</span>g</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div id="reader">
                <div class="scan-line"></div>
            </div>
            <div id="scan-status" style="font-size: 12px; color: var(--success); text-align: center; margin: 5px 0;"></div>
            
            <div style="display: flex; gap: 10px; margin: 10px 0;">
                <input type="text" id="food-n" placeholder="Meal Name" style="flex: 1; margin: 0;">
                <button onclick="startScanner()" style="width: 60px; margin: 0; padding: 0; background: #2C2C2E; border: 1px solid var(--primary); border-radius: 14px; display: flex; justify-content: center; align-items: center;">
                    ðŸ“·
                </button>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                <input type="number" id="f-kcal" placeholder="Cals">
                <input type="number" id="f-p" placeholder="P (g)">
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                <input type="number" id="f-c" placeholder="C (g)">
                <input type="number" id="f-f" placeholder="F (g)">
            </div>
            <button onclick="addEntry()">Add Meal</button>
        </div>
        
        <button onclick="localStorage.clear(); location.reload();" style="background:none; color:grey; font-size:12px; margin-top: 10px;">Reset Profile</button>
    </div>

    <script>
        let profile = JSON.parse(localStorage.getItem('aura_profile'));
        let logs = JSON.parse(localStorage.getItem('aura_logs')) || {};
        let today = new Date().toISOString().split('T')[0];
        let html5QrCode;

        function saveProfile() {
            const w = parseFloat(document.getElementById('curr-w').value);
            const tw = parseFloat(document.getElementById('target-w').value);
            const speed = parseInt(document.getElementById('speed').value);
            if(!w || !tw) return alert("Fill weight");
            const bmr = (10 * w) + 600;
            let targetCals = tw < w ? bmr - speed : bmr + speed;
            profile = { targetCals, p: Math.round(w * 2), f: Math.round((targetCals * 0.25) / 9), c: Math.round((targetCals - (w*2*4) - (targetCals*0.25)) / 4) };
            localStorage.setItem('aura_profile', JSON.stringify(profile));
            location.reload();
        }

        async function startScanner() {
            const readerDiv = document.getElementById('reader');
            readerDiv.style.display = 'block';
            
            if (!html5QrCode) {
                // Focus only on 1D barcodes (EAN-13, UPC, etc.)
                html5QrCode = new Html5Qrcode("reader", { 
                    formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.UPC_A, Html5QrcodeSupportedFormats.UPC_E, Html5QrcodeSupportedFormats.EAN_8 ] 
                });
            }

            try {
                await html5QrCode.start(
                    { facingMode: "environment" }, 
                    { fps: 20, qrbox: { width: 280, height: 120 } }, 
                    (decodedText) => {
                        html5QrCode.stop();
                        readerDiv.style.display = 'none';
                        fetchProductData(decodedText);
                    }
                );
            } catch (err) {
                document.getElementById('scan-status').innerText = "Camera error: Make sure you use HTTPS";
            }
        }

        async function fetchProductData(barcode) {
            document.getElementById('scan-status').innerText = "Searching " + barcode + "...";
            try {
                const r = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const d = await r.json();
                if (d.status === 1) {
                    const p = d.product;
                    document.getElementById('food-n').value = p.product_name || "Product";
                    document.getElementById('f-kcal').value = Math.round(p.nutriments['energy-kcal_100g'] || 0);
                    document.getElementById('f-p').value = Math.round(p.nutriments.proteins_100g || 0);
                    document.getElementById('f-c').value = Math.round(p.nutriments.carbohydrates_100g || 0);
                    document.getElementById('f-f').value = Math.round(p.nutriments.fat_100g || 0);
                    document.getElementById('scan-status').innerText = "Match found!";
                } else {
                    document.getElementById('scan-status').innerText = "Not in database.";
                }
            } catch (e) {
                document.getElementById('scan-status').innerText = "API Error.";
            }
        }

        function addEntry() {
            const entry = { k: parseInt(document.getElementById('f-kcal').value || 0), p: parseInt(document.getElementById('f-p').value || 0), c: parseInt(document.getElementById('f-c').value || 0), f: parseInt(document.getElementById('f-f').value || 0) };
            if(!logs[today]) logs[today] = [];
            logs[today].push(entry);
            localStorage.setItem('aura_logs', JSON.stringify(logs));
            updateUI();
        }

        function updateUI() {
            if(!profile) { document.getElementById('onboarding').style.display='block'; return; }
            let t = {k:0, p:0, c:0, f:0};
            (logs[today] || []).forEach(l => { t.k += l.k; t.p += l.p; t.c += l.c; t.f += l.f; });
            const ring = document.getElementById('ring-fill');
            const percent = Math.min(t.k / profile.targetCals, 1);
            ring.style.strokeDashoffset = 534 - (534 * percent);
            document.getElementById('cals-left').innerText = Math.max(0, profile.targetCals - t.k);
            document.getElementById('p-cur').innerText = t.p;
            document.getElementById('p-bar').style.width = Math.min((t.p/profile.p)*100, 100) + '%';
            document.getElementById('c-cur').innerText = t.c;
            document.getElementById('c-bar').style.width = Math.min((t.c/profile.c)*100, 100) + '%';
            document.getElementById('f-cur').innerText = t.f;
            document.getElementById('f-bar').style.width = Math.min((t.f/profile.f)*100, 100) + '%';
        }
        updateUI();
    </script>
</body>
</html>
