<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Aura AI Elite</title>
    <style>
        :root {
            --primary: #5856D6; --accent: #AF52DE; --success: #34C759;
            --warning: #FF9500; --danger: #FF3B30; --bg: #000000;
            --card: #1C1C1E; --text: #FFFFFF;
        }
        body { font-family: -apple-system, system-ui; background: var(--bg); color: var(--text); margin: 0; padding: 0; overflow-x: hidden; }
        #onboarding { position: fixed; inset: 0; background: var(--bg); z-index: 1000; padding: 40px 25px; overflow-y: auto; display: none; }
        .container { padding: 60px 20px 100px; }
        .card { background: var(--card); border-radius: 24px; padding: 20px; margin-bottom: 20px; border: 1px solid #38383A; }
        
        /* The Ring */
        .ring-container { position: relative; width: 200px; height: 200px; margin: 0 auto 20px; }
        svg { transform: rotate(-90deg); filter: drop-shadow(0 0 5px var(--primary)); }
        circle { fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 0.5s ease; }
        .bg-ring { stroke: #38383A; }
        .main-ring { stroke: var(--primary); }
        .ring-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }

        /* Macro Bars */
        .macro-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        .macro-label { font-size: 10px; color: #8E8E93; text-transform: uppercase; margin-bottom: 4px; }
        .progress-bar { height: 6px; background: #38383A; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.3s; }

        /* Inputs & UI */
        input, select { width: 100%; padding: 16px; background: #2C2C2E; border: none; border-radius: 14px; color: white; margin: 10px 0; font-size: 16px; box-sizing: border-box; }
        .slider-label { display: flex; justify-content: space-between; margin-top: 15px; font-size: 14px; }
        input[type="range"] { height: 30px; accent-color: var(--primary); }
        button { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border: none; border-radius: 16px; font-weight: 700; font-size: 17px; margin-top: 20px; cursor: pointer; }
        
        .ai-btn { background: #2C2C2E; border: 1px solid var(--primary); color: var(--primary); display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 0; }
        #ai-status { font-size: 12px; color: var(--accent); text-align: center; margin-bottom: 10px; font-weight: bold; }
        .loader { display: none; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="onboarding">
        <h1>Set Your Goal</h1>
        <label>Current Weight (kg)</label>
        <input type="number" id="curr-w" placeholder="80">
        <label>Target Weight (kg)</label>
        <input type="number" id="target-w" placeholder="75">
        
        <div class="slider-label">
            <span>Speed</span>
            <span id="speed-val">Steady</span>
        </div>
        <input type="range" id="speed" min="250" max="1000" step="250" value="500" 
               oninput="document.getElementById('speed-val').innerText = this.value == 1000 ? 'Aggressive' : (this.value == 250 ? 'Steady' : 'Moderate')">
        
        <button onclick="saveProfile()">Create Personal Plan</button>
    </div>

    <div class="container">
        <div class="ring-container">
            <svg width="200" height="200">
                <circle class="bg-ring" cx="100" cy="100" r="85"></circle>
                <circle class="main-ring" id="ring-fill" cx="100" cy="100" r="85" stroke-dasharray="534" stroke-dashoffset="534"></circle>
            </svg>
            <div class="ring-text">
                <div style="font-size: 32px; font-weight: 800;" id="cals-left">0</div>
                <div style="font-size: 12px; color: #8E8E93;">KCAL LEFT</div>
            </div>
        </div>

        <div class="card">
            <div class="macro-grid">
                <div>
                    <div class="macro-label">Protein</div>
                    <div class="progress-bar"><div id="p-bar" class="progress-fill" style="background:var(--danger)"></div></div>
                    <div style="font-size: 11px; margin-top:4px"><span id="p-cur">0</span>/<span id="p-max">0</span>g</div>
                </div>
                <div>
                    <div class="macro-label">Carbs</div>
                    <div class="progress-bar"><div id="c-bar" class="progress-fill" style="background:var(--success)"></div></div>
                    <div style="font-size: 11px; margin-top:4px"><span id="c-cur">0</span>/<span id="c-max">0</span>g</div>
                </div>
                <div>
                    <div class="macro-label">Fat</div>
                    <div class="progress-bar"><div id="f-bar" class="progress-fill" style="background:var(--warning)"></div></div>
                    <div style="font-size: 11px; margin-top:4px"><span id="f-cur">0</span>/<span id="f-max">0</span>g</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div id="ai-status">Ready to Log</div>
            
            <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none;" onchange="processImage(this)">
            
            <button class="ai-btn" onclick="document.getElementById('camera-input').click()">
                <div class="loader" id="ai-loader"></div> ðŸª„ AI Scan Plate
            </button>
            
            <input type="text" id="food-n" placeholder="Meal Name">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                <input type="number" id="f-kcal" placeholder="Cals" inputmode="numeric">
                <input type="number" id="f-p" placeholder="Prot (g)" inputmode="numeric">
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                <input type="number" id="f-c" placeholder="Carb (g)" inputmode="numeric">
                <input type="number" id="f-f" placeholder="Fat (g)" inputmode="numeric">
            </div>
            <button onclick="addEntry()">Log Meal</button>
        </div>
        
        <button onclick="clearAll()" style="background:none; color:grey; font-size:12px; margin-top: 10px; box-shadow: none;">Reset All Data</button>
    </div>

    <script>
        let profile = JSON.parse(localStorage.getItem('aura_profile'));
        let logs = JSON.parse(localStorage.getItem('aura_logs')) || {};
        let today = new Date().toISOString().split('T')[0];

        function saveProfile() {
            const w = parseFloat(document.getElementById('curr-w').value);
            const tw = parseFloat(document.getElementById('target-w').value);
            const speed = parseInt(document.getElementById('speed').value);
            
            if(!w || !tw) return alert("Please fill in weights");

            const bmr = (10 * w) + 600; // Original BMR logic
            let targetCals = tw < w ? bmr - speed : bmr + speed;
            
            profile = {
                targetCals,
                p: Math.round(w * 2),
                f: Math.round((targetCals * 0.25) / 9),
                c: Math.round((targetCals - (w*2*4) - (targetCals*0.25)) / 4)
            };
            localStorage.setItem('aura_profile', JSON.stringify(profile));
            location.reload();
        }

        // --- AI VISION LOGIC ---
        async function processImage(input) {
            const file = input.files[0];
            if (!file) return;

            let apiKey = localStorage.getItem('aura_ai_key');
            if (!apiKey) {
                apiKey = prompt("Enter your OpenAI API Key to use Vision AI (It will be saved locally on this device):");
                if (!apiKey) return;
                localStorage.setItem('aura_ai_key', apiKey);
            }

            document.getElementById('ai-status').innerText = "Analyzing meal with AI...";
            document.getElementById('ai-loader').style.display = "block";

            // Convert image to base64
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64Image = reader.result;

                try {
                    const response = await fetch("https://api.openai.com/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: "gpt-4o-mini",
                            messages: [
                                {
                                    role: "user",
                                    content: [
                                        { type: "text", text: "Estimate the calories and macros of the food in this image. Reply ONLY with a valid JSON object matching this exact structure: {\"name\": \"Food Name\", \"kcal\": 500, \"p\": 30, \"c\": 40, \"f\": 20}. Do not use markdown blocks." },
                                        { type: "image_url", image_url: { url: base64Image } }
                                    ]
                                }
                            ],
                            max_tokens: 150
                        })
                    });

                    const data = await response.json();
                    
                    if(data.error) {
                        if(data.error.code === 'invalid_api_key') {
                            localStorage.removeItem('aura_ai_key');
                            throw new Error("Invalid API Key. Try again.");
                        }
                        throw new Error(data.error.message);
                    }

                    const resultText = data.choices[0].message.content.trim();
                    const aiData = JSON.parse(resultText);

                    // Populate UI with AI estimates
                    document.getElementById('food-n').value = aiData.name || "AI Estimation";
                    document.getElementById('f-kcal').value = aiData.kcal || 0;
                    document.getElementById('f-p').value = aiData.p || 0;
                    document.getElementById('f-c').value = aiData.c || 0;
                    document.getElementById('f-f').value = aiData.f || 0;
                    
                    document.getElementById('ai-status').innerText = "AI Estimation Complete!";

                } catch (error) {
                    document.getElementById('ai-status').innerText = error.message || "AI Analysis Failed. Parse Error.";
                } finally {
                    document.getElementById('ai-loader').style.display = "none";
                    input.value = ""; // reset input
                }
            };
        }

        function addEntry() {
            const entry = {
                k: parseInt(document.getElementById('f-kcal').value || 0),
                p: parseInt(document.getElementById('f-p').value || 0),
                c: parseInt(document.getElementById('f-c').value || 0),
                f: parseInt(document.getElementById('f-f').value || 0)
            };
            if(!logs[today]) logs[today] = [];
            logs[today].push(entry);
            localStorage.setItem('aura_logs', JSON.stringify(logs));
            updateUI();
            
            // Clear inputs after logging
            ['food-n','f-kcal','f-p','f-c','f-f'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('ai-status').innerText = "Meal Logged!";
        }

        function updateUI() {
            if(!profile) { document.getElementById('onboarding').style.display='block'; return; }
            
            let totals = {k:0, p:0, c:0, f:0};
            (logs[today] || []).forEach(l => { totals.k += l.k; totals.p += l.p; totals.c += l.c; totals.f += l.f; });

            // Update Ring
            const ring = document.getElementById('ring-fill');
            const percent = Math.min(totals.k / profile.targetCals, 1);
            ring.style.strokeDashoffset = 534 - (534 * percent);
            document.getElementById('cals-left').innerText = Math.max(0, profile.targetCals - totals.k);

            // Update Macros
            const updateMacro = (id, cur, max) => {
                document.getElementById(id+'-cur').innerText = cur;
                document.getElementById(id+'-max').innerText = max;
                document.getElementById(id+'-bar').style.width = Math.min((cur/max)*100, 100) + '%';
            };
            updateMacro('p', totals.p, profile.p);
            updateMacro('c', totals.c, profile.c);
            updateMacro('f', totals.f, profile.f);
        }

        function clearAll() {
            localStorage.clear();
            location.reload();
        }

        updateUI();
    </script>
</body>
</html>
